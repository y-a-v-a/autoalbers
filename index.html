<!DOCTYPE html>
<html>
<head>
    <title>AutoAlbers</title>
    <style>
        html, body {
            padding: 0;
            margin: 0;
        }
        canvas {
            display: block;
            margin: 60px auto 0;
            border: 1px solid #dfdfdf;
        }
        #meter {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            line-height: 0;
            overflow: hidden;
        }
        #amount {
            position: relative;
            left: 0;
            top: 0;
            width: 0;
            height: 4px;
            line-height: 0;
            background: #bbb;
        }
    </style>
</head>
<body>
    <canvas id="autoalbers" width="600" height="600"></canvas>
    <div id="meter"><div id="amount"></div></div>
    <script src="color-scheme.js"></script>
    <script>
    'use strict';
    if (!Date.now)
        Date.now = function() { return new Date().getTime(); };

    (function() {
        var vendors = ['webkit', 'moz'];
        for (var i = 0; i < vendors.length && !window.requestAnimationFrame; ++i) {
            var vp = vendors[i];
            window.requestAnimationFrame = window[vp+'RequestAnimationFrame'];
            window.cancelAnimationFrame = (window[vp+'CancelAnimationFrame']
                                       || window[vp+'CancelRequestAnimationFrame']);
        }
        if (/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent) // iOS6 is buggy
            || !window.requestAnimationFrame || !window.cancelAnimationFrame) {
            var lastTime = 0;
            window.requestAnimationFrame = function(callback) {
                var now = Date.now();
                var nextTime = Math.max(lastTime + 16, now);
                return setTimeout(function() { callback(lastTime = nextTime); },
                                  nextTime - now);
            };
            window.cancelAnimationFrame = clearTimeout;
        }
    }());
    
    var handle;

    (function() {
        var interval
        , duration = 12
        , scale = 1.5
        , canvas = document.getElementById('autoalbers')
        , context = canvas.getContext('2d')

        , createAlbers = function createAlbers() {
            var keyCache = []
            , colors = []
            , getKey = function getKey() {
                var key = getRandomKey(colors.length);
                while (keyCache.indexOf(key) !== -1) {
                    key = getRandomKey(colors.length);
                }
                keyCache.push(key);
                return key;
            }
            , i = 0;

            colors = generateScheme();
            
            for(;i < 4; i += 1) {
                (function(i) {
                    var key = getKey()
                    , x = i * 40 * scale
                    , y = i * 60 * scale
                    , width = (400 * scale) - (i * 80 * scale)
                    , height = (400* scale) - (i * 80 * scale);
                    context.fillStyle = colors[key];
                    context.fillRect(x, y, width, height);
                }(i));
            }
        }
        
        , generateScheme = function generateScheme() {
            var colorScheme = new ColorScheme()
            , hue = Math.floor(Math.random() * 360)
            , schemes = ['mono', 'contrast', 'triade', 'tetrade', 'analogic']
            , variations = ['pastel', 'soft', 'light', 'hard', 'pale']
            , variation = variations[getRandomKey(variations.length)]
            , scheme = schemes[getRandomKey(schemes.length)]
            , distance
            , complement;
            
            colorScheme.from_hue(hue).scheme(scheme).variation(variation);
            if (scheme === 'analogic') {
                complement = !!Math.round(Math.random());
                colorScheme.add_complement(complement);
            }
            if (['mono', 'contrast'].indexOf(scheme) == -1) {
                distance = Math.random();
                colorScheme.distance(distance);
            }

//            console.log(hue, scheme, variation, complement, distance);
            
            return colorScheme.colors();
        }
        
        , getRandomKey = function getRandomKey(max) {
            return Math.floor(Math.random() * max);
        }

        , draw
        , element = document.getElementById('amount')
        , size = 0
        , step = (document.documentElement.clientWidth / duration)
        , was = 0
        , draw = function(time) {
            var delta = (time || 0) - was
            , jump = delta === 0 ? 0 : (step * (delta / 1000));
            handle = requestAnimationFrame(draw);
            element.style.width = (size += jump) + 'px';
            was = time || 0;
        }
        , timer = function timer() {
            cancelAnimationFrame(handle);
            size = 0;
            createAlbers();
            draw();
        };

        timer();
       interval = setInterval(timer, duration * 1000);
    }());
    
    function kill() {
        cancelAnimationFrame(handle);
    }
    
    </script>
</body>
</html>